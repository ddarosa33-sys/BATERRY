<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BT Ultra - Hardware Link</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #000; color: white; margin: 0; overflow: hidden; }
        .battery-anim { transition: width 1s ease-in-out; }
        .shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icons = {
            BT: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="m7 7 10 10-5 5V2l5 5L7 17"/></svg>,
            Zap: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" strokeWidth="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>,
            Error: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f43f5e" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        };

        function App() {
            const [state, setState] = useState({
                device: null,
                battery: null,
                loading: false,
                error: null,
                logs: "Listo para vincular"
            });

            const log = (msg) => {
                console.log(msg);
                setState(prev => ({ ...prev, logs: msg }));
            };

            const connect = async () => {
                setState(prev => ({ ...prev, loading: true, error: null }));
                log("Abriendo selector de sistema...");

                try {
                    // Paso 1: Selección de dispositivo (Sin filtros para máxima visibilidad)
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['battery_service', 'device_information']
                    });

                    log(`Conectando a: ${device.name || 'Dispositivo'}`);
                    
                    // Paso 2: Conexión GATT con reintento
                    const server = await device.gatt.connect();
                    log("Servidor GATT conectado. Buscando servicios...");

                    // Espera necesaria para algunos firmwares de parlantes
                    await new Promise(r => setTimeout(r, 1200));

                    try {
                        const service = await server.getPrimaryService('battery_service');
                        const characteristic = await service.getCharacteristic('battery_level');
                        
                        log("Leyendo batería...");
                        const value = await characteristic.readValue();
                        const level = value.getUint8(0);

                        setState(prev => ({ ...prev, device, battery: level, loading: false }));
                        log("Sincronización completa");

                        // Suscribir a cambios
                        await characteristic.startNotifications();
                        characteristic.addEventListener('characteristicvaluechanged', (e) => {
                            setState(prev => ({ ...prev, battery: e.target.value.getUint8(0) }));
                        });

                    } catch (serviceErr) {
                        log("El parlante no reporta nivel de batería estándar.");
                        setState(prev => ({ ...prev, device, battery: "N/A", loading: false }));
                    }

                    device.addEventListener('gattserverdisconnected', () => {
                        setState({ device: null, battery: null, loading: false, error: "Conexión cerrada", logs: "Desconectado" });
                    });

                } catch (err) {
                    console.error(err);
                    setState(prev => ({ ...prev, loading: false, error: "Error de conexión: Verifica si el parlante ya está conectado a otro equipo." }));
                    log("Error de enlace físico.");
                }
            };

            return (
                <div className="min-h-screen bg-black flex flex-col max-w-md mx-auto border-x border-white/5 shadow-2xl relative">
                    <header className="p-8 pt-16">
                        <h1 className="text-3xl font-black italic tracking-tighter uppercase flex items-center gap-2">
                            <Icons.BT /> Power BT
                        </h1>
                        <div className="flex items-center gap-2 mt-2">
                            <div className={`w-1.5 h-1.5 rounded-full ${state.device ? 'bg-emerald-500 animate-pulse' : 'bg-white/20'}`}></div>
                            <span className="text-[9px] font-bold text-white/40 uppercase tracking-[0.3em]">{state.logs}</span>
                        </div>
                    </header>

                    <main className="flex-1 px-8 flex flex-col justify-center">
                        {state.error && (
                            <div className="mb-8 bg-rose-500/10 border border-rose-500/20 p-4 rounded-2xl flex items-center gap-3">
                                <Icons.Error />
                                <span className="text-[11px] font-bold text-rose-400 uppercase leading-tight">{state.error}</span>
                            </div>
                        )}

                        {!state.device ? (
                            <div className="text-center space-y-10">
                                <div className="w-32 h-32 mx-auto bg-white/5 rounded-full flex items-center justify-center border border-white/10 relative overflow-hidden">
                                    <Icons.BT />
                                    {state.loading && <div className="absolute inset-0 shimmer"></div>}
                                </div>
                                <button 
                                    onClick={connect}
                                    disabled={state.loading}
                                    className="w-full bg-white text-black font-black py-6 rounded-[2rem] active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                                >
                                    {state.loading ? "CONECTANDO..." : "VINCULAR PARLANTE"}
                                </button>
                                <p className="text-[10px] text-white/30 font-bold uppercase tracking-widest px-8 leading-loose">
                                    Asegúrate de que el parlante no esté en uso por otra app.
                                </p>
                            </div>
                        ) : (
                            <div className="bg-white/5 border border-white/10 p-10 rounded-[3rem] animate-in zoom-in-95">
                                <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">Hardware Conectado</p>
                                <h2 className="text-4xl font-black tracking-tighter mb-12 truncate">{state.device.name || "Parlante"}</h2>
                                
                                <div className="space-y-6">
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-8xl font-black tracking-tighter tabular-nums">
                                            {state.battery === "N/A" ? "--" : (state.battery ?? "0")}
                                        </span>
                                        <span className="text-2xl font-bold text-white/30">%</span>
                                    </div>
                                    <div className="h-3 bg-white/5 rounded-full p-0.5">
                                        <div 
                                            className="h-full bg-indigo-500 rounded-full battery-anim shadow-[0_0_20px_rgba(99,102,241,0.4)]"
                                            style={{ width: `${(state.battery && state.battery !== "N/A") ? state.battery : 0}%` }}
                                        ></div>
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={() => state.device.gatt.disconnect()}
                                    className="mt-12 w-full text-[9px] font-black text-white/20 uppercase tracking-[0.5em] hover:text-rose-500"
                                >
                                    Desconectar
                                </button>
                            </div>
                        )}
                    </main>

                    <footer className="p-10 flex flex-col items-center gap-2">
                        <Icons.Zap />
                        <span className="text-[8px] font-black text-white/20 uppercase tracking-[0.4em]">Web Bluetooth v2.0 Standard</span>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

